#!/usr/bin/env bash
set -euo pipefail

mapfile -t files < <(git diff --cached --name-only --diff-filter=ACM || true)
((${#files[@]})) || exit 0

bad=0

for f in "${files[@]}"; do
  [[ -f "$f" ]] || continue

  if LC_ALL=C grep -Il $'\x00' -- "$f" >/dev/null 2>&1; then
    echo "NUL byte found in $f" >&2
    bad=1
  fi

  if ! perl -ne 'exit 1 if /[^\t\n\r\x20-\x7E]/; END{exit 0}' "$f"; then
    echo "Control/non-printable characters found in $f" >&2
    command -v xxd >/dev/null && xxd -g 1 -l 64 -- "$f" >&2 || true
    bad=1
  fi
done

if ((bad)); then
  echo "[FAIL] Pre-commit failed: strip control characters before committing." >&2
  exit 1
fi

echo "[PASS] Control-char check passed."
